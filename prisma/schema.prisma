// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================
// Roles & Users
// =============================
model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique // "admin", "consultant", "organization"
  displayName String   // "Administrator", "Consultant", "Organization"
  createdAt   DateTime @default(now())
  users       User[]
}

model User {
  id        Int          @id @default(autoincrement())
  name      String
  email     String       @unique
  password  String
  roleId    Int
  role      Role         @relation(fields: [roleId], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  tokens    ResetToken[]

  // Para consultores: empresas que auditan
  audits Audit[]

  // Para organizaciones: empresa que representan
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // Formularios personalizados creados por este usuario
  personalizedForms PersonalizedForm[] @relation("PersonalizedFormOwner")

  // Reports created by this organization user
  reports Report[] @relation("ReportOwner")

  opportunities Opportunity[]
  needs         Need[]
  problems      Problem[]

  // Nuevas prioridades
  highPriorities     HighPriority[]
  mediumPriorities   MediumPriority[]
  lowPriorities      LowPriority[]
  mediumPriorities2  MediumPriority2[]
}

model ResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================
// Dynamic Forms (templates)
// =============================

model Module {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  forms       Form[]
}

model Form {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  tag         String?
  moduleId    Int
  module      Module     @relation(fields: [moduleId], references: [id])
  categories  Category[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  isPublished Boolean    @default(false)
  personalizedForms PersonalizedForm[]
}

// =============================
// Empresas y Auditor√≠as
// =============================

model Organization {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users  User[]
  audits Audit[]
}

model Audit {
  id             Int      @id @default(autoincrement())
  name           String
  description    String?
  consultantId   Int
  organizationId Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  consultant   User         @relation(fields: [consultantId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  personalizedForms PersonalizedForm[]

  @@unique([consultantId, organizationId, name])
}

// =============================
// Organization Reports
// =============================

model Report {
  id        Int      @id @default(autoincrement())
  name      String
  version   Int      @default(1)
  userId    Int
  user      User     @relation("ReportOwner", fields: [userId], references: [id])
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  personalizedForms PersonalizedForm[]

  @@unique([userId, name, version])
}

// =============================
// Formularios Personalizados
// =============================

model PersonalizedForm {
  id   Int    @id @default(autoincrement())
  name String

  baseFormId Int
  baseForm   Form @relation(fields: [baseFormId], references: [id])

  userId Int
  user   User @relation("PersonalizedFormOwner", fields: [userId], references: [id])

  auditId Int?
  audit   Audit? @relation(fields: [auditId], references: [id])

  reportId Int?
  report   Report? @relation(fields: [reportId], references: [id])

  isCompleted Boolean   @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  personalizedCategories PersonalizedCategory[]

  @@unique([userId, baseFormId, auditId, reportId])
}

model PersonalizedCategory {
  id   Int    @id @default(autoincrement())
  name String

  baseCategoryId Int
  baseCategory   Category @relation("BaseCategory", fields: [baseCategoryId], references: [id])

  personalizedFormId Int
  personalizedForm   PersonalizedForm @relation(fields: [personalizedFormId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  personalizedItems PersonalizedItem[]

  @@unique([personalizedFormId, baseCategoryId])
}

model PersonalizedItem {
  id       Int     @id @default(autoincrement())
  name     String
  isCustom Boolean @default(false)

  baseItemId Int?
  baseItem   Item? @relation("BaseItem", fields: [baseItemId], references: [id])

  personalizedCategoryId Int
  personalizedCategory   PersonalizedCategory @relation(fields: [personalizedCategoryId], references: [id], onDelete: Cascade)

  score Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([personalizedCategoryId, baseItemId])
  @@unique([personalizedCategoryId, name])
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  formId    Int
  form      Form     @relation(fields: [formId], references: [id])
  items     Item[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  personalizedCategories PersonalizedCategory[] @relation("BaseCategory")

  @@unique([name, formId])
}

model Item {
  id         Int      @id @default(autoincrement())
  name       String
  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  personalizedItems PersonalizedItem[] @relation("BaseItem")

  @@unique([name, categoryId])
}

// =============================
// Oportunidades, Necesidades y Problemas
// =============================

model Opportunity {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Need {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Problem {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================
// Prioridades
// =============================

model HighPriority {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MediumPriority {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LowPriority {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MediumPriority2 {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}